<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encantos de la selva - Online Store</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="encantos.css">
    <script src="products.js"></script>
    <script src="https://app.aminos.ai/js/chat_plugin.js" data-bot-id="54928"></script>
    
    
    
    
    
    
    
    
</head>
<body>
    <!-- Header with Hero Section -->
    <header>
        <div class="logo-container">
            <div class="logo">
                <i class="fas fa-shopping-bag"></i>
            </div>
            <h1 class="store-name">Encantos de la selva</h1>
        </div>
        <div class="hero-content">
            <p>Desde la selva su encantos!</p>
        </div>
    </header>

    <!-- Search Bar -->
    <div class="search-container">
        <div class="search-bar">
            <input type="text" id="search-input" placeholder="Buscar productos...">
            <button id="search-btn"><i class="fas fa-search"></i> Buscar </button>
        </div>
    </div>

    <!-- Products Grid -->
    <div class="products-container">
        <h2 class="section-title">Nuestra coleccion </h2>
        <div class="products-grid" id="products-grid">
            <!-- Products will be dynamically inserted here -->
        </div>
    </div>

    <!-- Floating Cart Button -->
    <div class="cart-btn" id="cart-btn">
        <i class="fas fa-shopping-cart"></i>
        <div class="cart-count" id="cart-count">0</div>
    </div>

    <!-- Cart Sidebar -->
    <div class="cart-sidebar" id="cart-sidebar">
        <div class="cart-header">
            <h2 class="cart-title">Tu carrito</h2>
            <button class="close-cart" id="close-cart"><i class="fas fa-times"></i></button>
        </div>
        <div class="cart-items" id="cart-items">
            <!-- Cart items will be dynamically inserted here -->
        </div>
        <div class="cart-summary">
            <div class="cart-total">
                <span>Total:</span>
                <span id="cart-total">S/0.00</span>
            </div>
            <button class="checkout-btn" id="checkout-btn">Proceder a detailes del envio</button>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="checkout-modal">
            <div class="modal-header">
                <h2 class="modal-title">Completa tu pedido</h2>
                <p class="modal-subtitle">A donde envamos este pedido?</p>
            </div>
            <form id="checkout-form">
                <div class="form-group">
                    <label for="customer-name">Nombre completo</label>
                    <input type="text" id="customer-name" required>
                </div>
                <div class="form-group">
                    <label for="customer-dni">DNI</label>
                    <input type="text" id="customer-dni" required>
                </div>
                <div class="form-group">
                    <label for="customer-email">Correo electrónico</label>
                    <input type="email" id="customer-email" required>
                </div>
                <div class="form-group">
                    <label for="customer-phone">Número de WhatsApp</label>
                    <input type="tel" id="customer-phone" required>
                </div>
                <div class="form-group">
                    <label for="customer-address">Dirección de envío</label>
                    <input type="text" id="customer-address" required>
                </div>
                <div class="form-group">
                    <label for="shipping-method">Método de envío</label>
                    <select id="shipping-method" required>
                        <option value="">Eligir metodo de envio</option>
                        <option value="Shalom">Shalom (oficina)</option>
                        <option value="Olva (domicilio)">Olva (domicilio)</option>
                        <option value="Olva (oficina)">Olva (oficina)</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" id="cancel-order">Cancelar</button>
                  <button type="submit" class="submit-order">
  <i class="fas fa-paper-plane"></i> Enviar
</button>

                </div>
            </form>
        </div>
    </div>

  <script>

      let products = productData.map(product => ({
    ...product,
    id: product.catalog_id
}));
  

        // DOM Elements
        const productsGrid = document.getElementById('products-grid');
        const cartBtn = document.getElementById('cart-btn');
        const cartSidebar = document.getElementById('cart-sidebar');
        const closeCart = document.getElementById('close-cart');
        const cartItems = document.getElementById('cart-items');
        const cartCount = document.getElementById('cart-count');
        const cartTotal = document.getElementById('cart-total');
        const checkoutBtn = document.getElementById('checkout-btn');
        const modalOverlay = document.getElementById('modal-overlay');
        const cancelOrder = document.getElementById('cancel-order');
        const checkoutForm = document.getElementById('checkout-form');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');

        // Cart state
        let cart = [];
        
        
        // Load products from external JSON file
async function loadProducts() {
    try {
        const response = await fetch('products.json');
        if (!response.ok) {
            throw new Error('Failed to load products');
        }
        products = await response.json();
        console.log(`Loaded ${products.length} products`);
    } catch (error) {
        console.error('Error loading products:', error);
        alert('Error al cargar productos. Por favor recarga la página.');
    }
}
        
        
        

        // Initialize the page
        async function init() {
    //await loadProducts();
    renderProducts();
    updateCartUI();
    setupEventListeners();
}
        
        
        // Generate unique order number
function generateOrderNumber() {
    const timestamp = Date.now().toString().slice(-6); // Last 6 digits of timestamp
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0'); // 3 random digits
    return `ORD-${timestamp}${random}`;
}

        // Render products to the page
      function renderProducts(productsToRender = products) {
            productsGrid.innerHTML = '';
            
            productsToRender.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" class="product-image">
                    <div class="product-info">
                        <h3 class="product-name">${product.name}</h3>
                        <p class="product-description">${product.description}</p>
                        
                        <p class="product-description"><b>Ingredientes: </b>${product.ingredients}</p>
                        
                        
                        <div class="product-price">S/${product.price.toFixed(2)}</div>
                        <div class="quantity-controls">
                            <button class="quantity-btn decrease" data-id="${product.id}">-</button>
                            <input type="number" class="quantity-input" data-id="${product.id}" value="1" min="1">
                            <button class="quantity-btn increase" data-id="${product.id}">+</button>
                        </div>
                        <button class="add-to-cart" data-id="${product.id}">Añadir al carrito</button>
                    </div>
                `;
                productsGrid.appendChild(productCard);
            });
        }

        // Set up event listeners
        function setupEventListeners() {
            // Cart toggle
            cartBtn.addEventListener('click', () => {
                cartSidebar.classList.toggle('open');
            });

            closeCart.addEventListener('click', () => {
                cartSidebar.classList.remove('open');
            });

            // Checkout process
            checkoutBtn.addEventListener('click', () => {
                if (cart.length === 0) {
                    alert('Your cart is empty. Add some products first!');
                    return;
                }
                modalOverlay.classList.add('open');
            });

            cancelOrder.addEventListener('click', () => {
                modalOverlay.classList.remove('open');
            });

            // Form submission
            checkoutForm.addEventListener('submit', (e) => {
                // Generate order number
                  const orderNumber = generateOrderNumber();
    
                // Send to WhatsApp (opens in new window)
                sendOrderViaWhatsApp(orderNumber);
    
                // Send to n8n backend for processing
                //sendOrderToN8n(orderNumber);
            });

            // Search functionality - updated for dynamic search
            searchInput.addEventListener('input', searchProducts);
            searchBtn.addEventListener('click', searchProducts);

            // Delegate events for product interactions
            document.addEventListener('click', (e) => {
                // Increase quantity
                if (e.target.classList.contains('increase')) {
                    const id = parseInt(e.target.dataset.id);
                    const input = document.querySelector(`.quantity-input[data-id="${id}"]`);
                    input.value = parseInt(input.value) + 1;
                }
                
                // Decrease quantity
                if (e.target.classList.contains('decrease')) {
                    const id = parseInt(e.target.dataset.id);
                    const input = document.querySelector(`.quantity-input[data-id="${id}"]`);
                    if (parseInt(input.value) > 1) {
                        input.value = parseInt(input.value) - 1;
                    }
                }
                
                // Add to cart
                if (e.target.classList.contains('add-to-cart')) {
                    const id = parseInt(e.target.dataset.id);
                    const input = document.querySelector(`.quantity-input[data-id="${id}"]`);
                    const quantity = parseInt(input.value);
                    addToCart(id, quantity);
                    input.value = 1; // Reset quantity input
                    
                    // Clear search input after adding to cart
                    searchInput.value = '';
                    renderProducts(); // Show all products again
                }
                
                // Remove item from cart
                if (e.target.classList.contains('remove-item')) {
                    const id = parseInt(e.target.dataset.id);
                    removeFromCart(id);
                }
            });

            // Update quantity in cart
            cartItems.addEventListener('change', (e) => {
                if (e.target.classList.contains('cart-item-quantity-input')) {
                    const id = parseInt(e.target.dataset.id);
                    const quantity = parseInt(e.target.value);
                    updateCartItemQuantity(id, quantity);
                }
            });
        }

        // Add product to cart
        function addToCart(productId, quantity) {
            const product = products.find(p => p.id === productId);
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    image: product.image,
                    quantity: quantity
                });
            }
            
            updateCartUI();
            showNotification(`${product.name} añadido al carrito!`);
        }

        // Remove product from cart
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCartUI();
        }

        // Update cart item quantity
        function updateCartItemQuantity(productId, quantity) {
            if (quantity < 1) {
                removeFromCart(productId);
                return;
            }
            
            const item = cart.find(item => item.id === productId);
            if (item) {
                item.quantity = quantity;
                updateCartUI();
            }
        }

        // Update cart UI
        function updateCartUI() {
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="empty-cart">Tu carrito está vacío</p>';
                cartCount.textContent = '0';
                cartTotal.textContent = '$0.00';
                return;
            }
            
            let total = 0;
            let count = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                count += item.quantity;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" class="cart-item-image">
                    <div class="cart-item-details">
                        <h3 class="cart-item-name">${item.name}</h3>
                        <div class="cart-item-price">S/${item.price.toFixed(2)} × ${item.quantity} = S/${itemTotal.toFixed(2)}</div>
                        <div class="cart-item-quantity">
                            <label for="quantity-${item.id}">Cant:</label>
                            <input type="number" id="quantity-${item.id}" class="cart-item-quantity-input" 
                                data-id="${item.id}" value="${item.quantity}" min="1">
                        </div>
                        <button class="remove-item" data-id="${item.id}">Eliminar</button>
                    </div>
                `;
                cartItems.appendChild(cartItem);
            });
            
            cartCount.textContent = count;
            cartTotal.textContent = `S/${total.toFixed(2)}`;
        }

        // Search products - updated for dynamic search
        function searchProducts() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                renderProducts();
                return;
            }
            
            const filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) || 
                product.description.toLowerCase().includes(searchTerm)
            );
            
            productsGrid.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                productsGrid.innerHTML = '<p class="no-results">No se encuentra este producto. Intenta otro.</p>';
                return;
            }
            
            renderProducts(filteredProducts);
        }
        
        
        
        
        

        // Show notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #25D366;
                color: white;
                padding: 12px 24px;
                border-radius: 50px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 9999;
                animation: fadeIn 0.3s, fadeOut 0.3s 2.7s forwards;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        // Send order to n8n webhook
function sendOrderToN8n(orderNumber) {
    const name = document.getElementById('customer-name').value;
    const email = document.getElementById('customer-email').value;
    const phone = document.getElementById('customer-phone').value;
    const address = document.getElementById('customer-address').value;
    const shippingMethod = document.getElementById('shipping-method').value;
    const dni = document.getElementById('customer-dni').value;

    // Calculate order total
    const orderTotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);

    // Build order data
    const orderData = {
    orderNumber: orderNumber,
  customer: { name, email, phone, address, shippingMethod, dni }, cart, total: orderTotal
    };

    // Send to n8n webhook
    fetch("https://encantos-automations-n8n.qsirhi.easypanel.host/webhook-test/order", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(orderData)
    })
    .then(async response => {
    if (!response.ok) {
        throw new Error("Order submission failed");
    }
    const html = await response.text();   // get HTML returned by n8n
    document.open();
    document.write(html);                 // replace current page with thank-you page
    document.close();
})
.catch(error => {
    console.error("Error:", error);
    alert("Network error. Please try again.");
});
}

        
        
        // Send order via WhatsApp
        function sendOrderViaWhatsApp(orderNumber) {
            const name = document.getElementById('customer-name').value;
            const dni = document.getElementById('customer-dni').value;
            const email = document.getElementById('customer-email').value;
            const phone = document.getElementById('customer-phone').value;
            const address = document.getElementById('customer-address').value;
            const shippingMethod = document.getElementById('shipping-method').value;
            
            // Calculate order total
            const orderTotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            
            // Create order summary
            let orderSummary = `*Nuevo pedido: ${orderNumber}*%0A%0A`;
            orderSummary += `*Cliente:* ${name}%0A`;;
            orderSummary += `*DNI:* ${dni}%0A`;
            orderSummary += `*Correo:* ${email}%0A`;
            orderSummary += `*Cel:* ${phone}%0A`;
            orderSummary += `*Direccion:* ${address}%0A`;
            orderSummary += `*Método de envío:* ${shippingMethod}%0A%0A`;
            orderSummary += `*Carrito:*%0A`;
            
            cart.forEach(item => {
                //orderSummary += `- ${item.name} (Qty: ${item.quantity}) - S/${(item.price * item.quantity).toFixed(2)}%0A`;
                orderSummary += `- ${item.quantity} x ${item.name} = S/${(item.price * item.quantity).toFixed(2)}%0A`;
            });
            
            orderSummary += `%0A*Total: S/${orderTotal.toFixed(2)}*`;
            
            // Create WhatsApp URL
            const whatsappURL = `https://wa.me/51935187862?text=${orderSummary}`;
            
            // Open WhatsApp in a new tab
            window.open(whatsappURL, '_blank');
            
            // Close modal and reset cart
            modalOverlay.classList.remove('open');
            cart = [];
            updateCartUI();
            checkoutForm.reset();
            
            // Show confirmation message
            showNotification('Tu pedido fue enviado! Ver a tu WhatsApp.');
        }

        // Initialize the app
        init();
    </script>
</body>
</html>
